<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>ç¼–è¾‘æ–‡ç«  - CF-blog åå°ç®¡ç†</title>
	<link rel="icon" type="image/x-icon" href="https://cdn.jsdelivr.net/gh/gdtool/zhaopp/cfblog/favicon.ico" />
	<link rel="shortcut icon" type="image/x-icon"  href="https://cdn.jsdelivr.net/gh/gdtool/zhaopp/cfblog/favicon.ico"/>
	<link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/editor.md@1.5.0/css/editormd.css" />
	<link rel="stylesheet" href="https://cdn.staticfile.org/bootstrap-select/1.9.4/css/bootstrap-select.min.css">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">

	<script src="https://cdn.staticfile.org/jquery/2.2.4/jquery.min.js"></script>
	<script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/i18n/defaults-zh_CN.min.js"></script>

	<style>
		/* ========== å…¨å±€æ ·å¼ ========== */
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
			background: #f5f7fa;
			color: #2c3e50;
			line-height: 1.6;
			transition: background 0.3s, color 0.3s;
		}

		/* ========== é¡¶éƒ¨å¯¼èˆªæ  ========== */
		.admin-header {
			background: #fff;
			box-shadow: 0 2px 8px rgba(0,0,0,0.08);
			padding: 0;
			margin-bottom: 30px;
			border-bottom: 2px solid #3b82f6;
		}

		.admin-header .navbar {
			margin-bottom: 0;
			border: none;
			border-radius: 0;
		}

		.admin-header .navbar-brand {
			font-size: 20px;
			font-weight: 600;
			color: #3b82f6 !important;
			padding: 15px 20px;
		}

		.admin-header .nav-tabs {
			border-bottom: none;
		}

		.admin-header .nav-tabs > li > a {
			border: none !important;
			border-radius: 0;
			padding: 15px 25px;
			color: #666;
			font-weight: 500;
			transition: all 0.3s;
		}

		.admin-header .nav-tabs > li > a:hover {
			background: #f0f7ff;
			color: #3b82f6;
		}

		.admin-header .nav-tabs > li.active > a {
			background: #3b82f6 !important;
			color: #fff !important;
			border: none !important;
		}

		/* ========== å¡ç‰‡å®¹å™¨ ========== */
		.admin-card {
			background: #fff;
			border-radius: 8px;
			box-shadow: 0 2px 12px rgba(0,0,0,0.08);
			padding: 25px;
			margin-bottom: 25px;
		}

		.admin-card h3 {
			font-size: 20px;
			font-weight: 600;
			color: #2c3e50;
			margin-bottom: 20px;
			padding-bottom: 12px;
			border-bottom: 2px solid #e5e7eb;
		}

		/* ========== è¡¨å•æ ·å¼ ========== */
		.form-group {
			margin-bottom: 20px;
		}

		.form-group label {
			display: block;
			font-weight: 500;
			color: #4b5563;
			margin-bottom: 8px;
		}

		.form-control {
			height: 42px;
			border: 1px solid #d1d5db;
			border-radius: 6px;
			padding: 8px 12px;
			font-size: 14px;
			transition: all 0.3s;
		}

		.form-control:focus {
			border-color: #3b82f6;
			box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
			outline: none;
		}

		textarea.form-control {
			height: auto;
			resize: vertical;
		}

		/* ========== æŒ‰é’®æ ·å¼ ========== */
		.btn {
			padding: 10px 20px;
			border-radius: 6px;
			font-size: 14px;
			font-weight: 500;
			transition: all 0.3s;
			border: none;
			cursor: pointer;
		}

		.btn-primary {
			background: #3b82f6;
			color: #fff;
		}

		.btn-primary:hover {
			background: #2563eb;
			transform: translateY(-1px);
			box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
		}

		.btn-default {
			background: #fff;
			color: #666;
			border: 1px solid #d1d5db;
		}

		.btn-default:hover {
			background: #f9fafb;
			border-color: #3b82f6;
			color: #3b82f6;
		}

		.btn-warning {
			background: #ef4444;
			color: #fff;
		}

		.btn-warning:hover {
			background: #dc2626;
			transform: translateY(-1px);
			box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
		}

		.btn-group {
			display: flex;
			gap: 10px;
			margin-top: 20px;
		}

		/* ========== æ·±è‰²æ¨¡å¼åˆ‡æ¢æŒ‰é’®æ ·å¼ ========== */
		.dark-mode-toggle {
			position: fixed;
			top: 20px;
			right: 20px;
			width: 45px;
			height: 45px;
			background: #fff;
			border: 1px solid #e5e7eb;
			border-radius: 50%;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			box-shadow: 0 2px 8px rgba(0,0,0,0.1);
			z-index: 1000;
			transition: all 0.3s;
		}

		.dark-mode-toggle:hover {
			background: #f9fafb;
			border-color: #3b82f6;
			transform: translateY(-2px);
			box-shadow: 0 4px 12px rgba(0,0,0,0.15);
		}

		.dark-mode-toggle svg {
			width: 22px;
			height: 22px;
			fill: #666;
		}

		/* ========== æ·±è‰²æ¨¡å¼æ ·å¼ ========== */
		html.dark body {
			background: #0f172a;
			color: #e2e8f0;
		}

		html.dark .admin-header {
			background: #1e293b;
			border-bottom-color: #3b82f6;
		}

		html.dark .admin-header .navbar-brand {
			color: #60a5fa !important;
		}

		html.dark .admin-header .nav-tabs > li > a {
			color: #94a3b8;
		}

		html.dark .admin-header .nav-tabs > li > a:hover {
			background: #334155;
			color: #60a5fa;
		}

		html.dark .admin-card {
			background: #1e293b;
			box-shadow: 0 2px 12px rgba(0,0,0,0.3);
		}

		html.dark .admin-card h3 {
			color: #f1f5f9;
			border-bottom-color: #334155;
		}

		html.dark .form-group label {
			color: #cbd5e1;
		}

		html.dark .form-control {
			background: #0f172a;
			border-color: #334155;
			color: #e2e8f0;
		}

		html.dark .form-control:focus {
			border-color: #60a5fa;
			box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
		}

		html.dark .btn-default {
			background: #334155;
			border-color: #475569;
			color: #cbd5e1;
		}

		html.dark .btn-default:hover {
			background: #475569;
			border-color: #60a5fa;
			color: #60a5fa;
		}

		html.dark .dark-mode-toggle {
			background: #1e293b;
			border-color: #334155;
		}

		html.dark .dark-mode-toggle:hover {
			background: #334155;
			border-color: #60a5fa;
		}

		html.dark .dark-mode-toggle svg {
			fill: #94a3b8;
		}

		.bootstrap-select>.dropdown-toggle {
			z-index:auto;
		}

		/* ========== ç¼–è¾‘å™¨å®¹å™¨ ========== */
		#content {
			margin-top: 20px;
		}

		/* ========== å“åº”å¼ ========== */
		@media (max-width: 768px) {
			.admin-header .nav-tabs > li > a {
				padding: 12px 15px;
				font-size: 13px;
			}

			.admin-card {
				padding: 15px;
			}

			.dark-mode-toggle {
				width: 40px;
				height: 40px;
			}
		}
	</style>

</head>
<body>

<!-- æ·±è‰²æ¨¡å¼åˆ‡æ¢æŒ‰é’® -->
<button class="dark-mode-toggle" id="darkModeToggle" title="åˆ‡æ¢æ·±è‰²æ¨¡å¼">
	<svg viewBox="0 0 24 24">
		<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
	</svg>
</button>

<div class="admin-header">
	<nav class="navbar navbar-default" role="navigation">
		<div class="container-fluid">
			<div class="navbar-header">
				<a class="navbar-brand" href="/admin/">ğŸ“ CF-Blog åå°ç®¡ç†</a>
			</div>
			<ul id="myTab" class="nav nav-tabs navbar-right" style="margin-right: 60px;">
				<li class="active">
					<a href="/admin/">â¬…ï¸ è¿”å›åå°</a>
				</li>
			</ul>
		</div>
	</nav>
</div>

<div id="myTabContent" class="tab-content container">
	<div class="admin-card">
		<h3>âœï¸ ç¼–è¾‘æ–‡ç« </h3>

		<form id="editForm">
			<input type="hidden" class="form-control" name="id" id="id">

			<div class="form-group">
				<label for="title">æ–‡ç« æ ‡é¢˜ *</label>
				<input type="text" class="form-control" name="title" id="title" placeholder="è¯·è¾“å…¥æ–‡ç« æ ‡é¢˜" required="true">
			</div>

			<div class="row">
				<div class="col-md-6">
					<div class="form-group">
						<label for="img">ç‰¹è‰²å›¾ç‰‡</label>
						<div style="display: flex; gap: 8px;">
							<input type="url" class="form-control" name="img" id="img" placeholder="https://example.com/image.jpg" style="flex: 1;">
							<button type="button" class="btn btn-primary" onclick="uploadFeaturedImage()" style="white-space: nowrap;">ğŸ“¤ ä¸Šä¼ åˆ° R2</button>
						</div>
					</div>
				</div>
				<div class="col-md-6">
					<div class="form-group">
						<label for="link">æ°¸ä¹…é“¾æ¥ *</label>
						<input type="text" class="form-control" name="link" id="link" placeholder="my-article-url" required="true">
					</div>
				</div>
			</div>

			<div class="row">
				<div class="col-md-6">
					<div class="form-group">
						<label for="createDate">åˆ›å»ºæ—¥æœŸ *</label>
						<input type="datetime-local" class="form-control" id="createDate" name="createDate" required="true">
					</div>
				</div>
				<div class="col-md-6">
					<div class="form-group">
						<label for="category">åˆ†ç±»</label>
						<select class="selectpicker form-control" multiple name="category[]" id="category" data-live-search="true"></select>
					</div>
				</div>
			</div>

			<div class="row">
				<div class="col-md-4">
					<div class="form-group">
						<label for="tags">æ ‡ç­¾</label>
						<input type="text" class="form-control" name="tags" id="tags" placeholder="æ ‡ç­¾1,æ ‡ç­¾2,æ ‡ç­¾3">
					</div>
				</div>
				<div class="col-md-4">
					<div class="form-group">
						<label for="priority">æƒé‡</label>
						<input type="text" class="form-control" name="priority" id="priority" value='0.5' placeholder="0.5">
					</div>
				</div>
				<div class="col-md-4">
					<div class="form-group">
						<label for="changefreq">æ›´æ–°é¢‘ç‡</label>
						<select class="form-control" id="changefreq" name="changefreq">
							<option value="daily" selected>æ¯å¤© (daily)</option>
							<option value="hourly">æ¯å°æ—¶ (hourly)</option>
							<option value="weekly">æ¯å‘¨ (weekly)</option>
							<option value="monthly">æ¯æœˆ (monthly)</option>
							<option value="yearly">æ¯å¹´ (yearly)</option>
							<option value="never">ä»ä¸ (never)</option>
							<option value="always">æ€»æ˜¯ (always)</option>
						</select>
					</div>
				</div>
			</div>

			<div class="form-group">
				<label>
					<input type="checkbox" name="isPinned" id="isPinned" value="on">
					<strong>ç½®é¡¶æ–‡ç« </strong> <small class="text-muted">(ç½®é¡¶çš„æ–‡ç« å°†æ˜¾ç¤ºåœ¨åˆ—è¡¨é¡¶éƒ¨)</small>
				</label>
			</div>

			<!-- å¯†ç ä¿æŠ¤è®¾ç½® -->
			<div class="admin-card" style="margin-top: 20px;">
				<h3>ğŸ” å¯†ç ä¿æŠ¤è®¾ç½®</h3>
				<div class="form-group">
					<label for="password">æ–‡ç« å¯†ç </label>
					<input type="text" class="form-control" name="password" id="password" placeholder="ç•™ç©ºè¡¨ç¤ºä¸è®¾ç½®å¯†ç " autocomplete="off">
					<small class="text-muted">è®¾ç½®åï¼Œè®¿å®¢éœ€è¦è¾“å…¥å¯†ç æ‰èƒ½æŸ¥çœ‹æ–‡ç« å†…å®¹</small>
				</div>
				<div class="form-group">
					<label for="passwordHint">å¯†ç æç¤º</label>
					<input type="text" class="form-control" name="passwordHint" id="passwordHint" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„ç”Ÿæ—¥ï¼ˆå¯é€‰ï¼‰">
					<small class="text-muted">å¯é€‰ï¼Œå¸®åŠ©è®¿å®¢å›å¿†å¯†ç </small>
				</div>
			</div>

			<div class="btn-group">
				<button type="button" id="btn_saveEdit" class="btn btn-primary" onclick="saveEdit()">ğŸ’¾ ä¿å­˜æ–‡ç« </button>
				<button type="button" class="btn btn-success" onclick="publish()">ğŸš€ ä¿å­˜å¹¶å‘å¸ƒ</button>
				<button type="button" id="btn_delete" class="btn btn-warning" onclick="deleteArticle()">ğŸ—‘ï¸ åˆ é™¤æ–‡ç« </button>
				<button type="button" class="btn btn-info" onclick="insertImageToEditor()">ğŸ“· æ’å…¥å›¾ç‰‡</button>
				<a href="/admin/" class="btn btn-default">âŒ å–æ¶ˆç¼–è¾‘</a>
			</div>

			<div id="content"><textarea style="display:none;"></textarea></div>
		</form>
	</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/editor.md@1.5.0/editormd.js"></script>
<script type="text/javascript">
	// ========== å…¨å±€å˜é‡ ==========
	var mdEditor; // å£°æ˜ä¸ºå…¨å±€å˜é‡ï¼Œä¾›æ’å…¥å›¾ç‰‡å‡½æ•°ä½¿ç”¨

	// ========== æ·±è‰²æ¨¡å¼åˆ‡æ¢ ==========
	const darkModeToggle = document.getElementById('darkModeToggle');
	const sunIcon = '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>';
	const moonIcon = '<svg viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>';

	// ä» localStorage è¯»å–æ·±è‰²æ¨¡å¼è®¾ç½®
	const isDarkMode = localStorage.getItem('adminDarkMode') === 'true';
	if (isDarkMode) {
		document.documentElement.classList.add('dark');
		darkModeToggle.innerHTML = sunIcon;
	} else {
		darkModeToggle.innerHTML = moonIcon;
	}

	// åˆ‡æ¢æ·±è‰²æ¨¡å¼
	darkModeToggle.addEventListener('click', function() {
		const isDark = document.documentElement.classList.toggle('dark');
		localStorage.setItem('adminDarkMode', isDark);
		darkModeToggle.innerHTML = isDark ? sunIcon : moonIcon;
	});

	// ========== åˆå§‹åŒ– ==========
	$(function() {
		// è·å–æ–‡ç« æ•°æ®
		var articleJson = <!--{articleJson}-->;
		// è·å–åˆ†ç±»æ•°æ®
		var categoryJson = <!--{categoryJson}-->;

		// åˆå§‹åŒ– MarkDown ç¼–è¾‘å™¨ï¼ˆèµ‹å€¼ç»™å…¨å±€å˜é‡ï¼‰
		mdEditor = editormd("content", {
			height : 640,
			path   : "https://cdn.jsdelivr.net/npm/editor.md@1.5.0/lib/",
			appendMarkdown : articleJson.contentMD,
			saveHTMLToTextarea : true,
			mode : "markdown",
			tex  : true,
			tocm : true,
			codeFold : true
		});

		// è¡¨å•èµ‹å€¼
		$('#id').val(articleJson.id);
		$('#title').val(articleJson.title);
		$('#img').val(articleJson.img);
		$('#link').val(articleJson.link);
		$('#createDate').val(articleJson.createDate.replace(" ","T"));
		$('#tags').val(articleJson.tags);
		$('#priority').val( (articleJson.priority === undefined ? "0.5" : articleJson.priority) );
		$('#changefreq').val( (articleJson.changefreq === undefined ? "daily" : articleJson.changefreq) );
		$('#isPinned').prop('checked', articleJson.isPinned === true);
		$('#password').val(articleJson.password || '');
		$('#passwordHint').val(articleJson.passwordHint || '');

		// åˆ†ç±»ä¸‹æ‹‰æ¡†èµ‹å€¼
		var category = $('#category');
		category.empty();
		for (var i = 0; i < categoryJson.length; i++) {
			category.append('<option value="' + categoryJson[i] + '">' + categoryJson[i] + '</option>');
		}
		category.selectpicker('val', articleJson.category);
		category.selectpicker('refresh');
	});

	// ========== ä¿å­˜æ–‡ç«  ==========
	function saveEdit(){
		$.ajax({
			type: "POST",
			dataType: "json",
			contentType: "application/json; charset=utf-8",
			url: "/admin/saveEdit/",
			data: JSON.stringify($("#editForm").serializeArray()),
			success: function (result) {
				alert(result.msg);
			}
		});
	}

	// ========== åˆ é™¤æ–‡ç«  ==========
	function deleteArticle(){
		if (confirm("ç¡®å®šåˆ é™¤å—?åˆ é™¤åé‡æ–°å‘å¸ƒæ‰èƒ½ç”Ÿæ•ˆ") == false){
			return false;
		}

		$.ajax({
			type: "POST",
			dataType: "json",
			contentType: "application/json; charset=utf-8",
			url: "/admin/delete/" + $('#id').val(),
			data: JSON.stringify([{"id": $('#id').val()}]),
			success: function (result) {
				alert(result.msg);
			}
		});
	}

	// ========== å‘å¸ƒ ==========
	function publish(){
		if (confirm("ç¡®å®šå—?ä¿å­˜å¹¶å‘å¸ƒå°†æ¸…ç†æ‰€æœ‰é™æ€ç¼“å­˜,é‡æ–°ç”Ÿæˆ") == false){
			return false;
		}

		// ç¬¬ä¸€æ­¥ï¼šå…ˆä¿å­˜æ–‡ç« 
		$.ajax({
			type: "POST",
			dataType: "json",
			contentType: "application/json; charset=utf-8",
			url: "/admin/saveEdit/",
			data: JSON.stringify($("#editForm").serializeArray()),
			success: function (result) {
				if (result.msg) {
					alert(result.msg);

					// ç¬¬äºŒæ­¥ï¼šä¿å­˜æˆåŠŸåè‡ªåŠ¨å‘å¸ƒ
					$.ajax({
						type: "POST",
						dataType: "json",
						contentType: "application/json; charset=utf-8",
						url: "/admin/publish/",
						success: function (publishResult) {
							alert(publishResult.msg);
						}
					});
				} else {
					alert("æ ‡é¢˜ã€æ—¶é—´ã€åˆ†ç±»å¿…å¡«");
				}
			}
		});
	}

	// ========== R2 å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½ ==========
	// ä¸Šä¼ ç‰¹è‰²å›¾ç‰‡åˆ° R2
	function uploadFeaturedImage(){
		var input = document.createElement('input');
		input.type = 'file';
		input.accept = 'image/jpeg,image/png,image/gif,image/webp';
		input.onchange = function(e){
			var file = e.target.files[0];
			if(!file){
				return;
			}

			// éªŒè¯æ–‡ä»¶ç±»å‹
			var allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
			if(!allowedTypes.includes(file.type)){
				alert('ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹ï¼ä»…æ”¯æŒ JPGã€PNGã€GIFã€WebP');
				return;
			}

			// éªŒè¯æ–‡ä»¶å¤§å° (5 MB)
			if(file.size > 5 * 1024 * 1024){
				alert('æ–‡ä»¶è¿‡å¤§ï¼æœ€å¤§æ”¯æŒ 5 MB');
				return;
			}

			// ä¸Šä¼ æ–‡ä»¶
			var formData = new FormData();
			formData.append('file', file);

			// æ˜¾ç¤ºä¸Šä¼ ä¸­
			var btn = event.target;
			var originalText = btn.textContent;
			btn.disabled = true;
			btn.textContent = 'ä¸Šä¼ ä¸­...';

			$.ajax({
				type: "POST",
				url: "/admin/uploadImage",
				data: formData,
				processData: false,
				contentType: false,
				dataType: "json",
				success: function(result){
					btn.disabled = false;
					btn.textContent = originalText;

					if(result.success){
						$('#img').val(result.url);
						alert('ä¸Šä¼ æˆåŠŸï¼URL å·²è‡ªåŠ¨å¡«å…¥');
					} else {
						alert('ä¸Šä¼ å¤±è´¥ï¼š' + result.error);
					}
				},
				error: function(xhr, status, error){
					btn.disabled = false;
					btn.textContent = originalText;
					alert('ä¸Šä¼ å¤±è´¥ï¼š' + error);
				}
			});
		};
		input.click();
	}

	// æ’å…¥å›¾ç‰‡åˆ°ç¼–è¾‘å™¨
	function insertImageToEditor(){
		var input = document.createElement('input');
		input.type = 'file';
		input.accept = 'image/jpeg,image/png,image/gif,image/webp';
		input.onchange = function(e){
			var file = e.target.files[0];
			if(!file){
				return;
			}

			// éªŒè¯æ–‡ä»¶ç±»å‹
			var allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
			if(!allowedTypes.includes(file.type)){
				alert('ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹ï¼ä»…æ”¯æŒ JPGã€PNGã€GIFã€WebP');
				return;
			}

			// éªŒè¯æ–‡ä»¶å¤§å° (5 MB)
			if(file.size > 5 * 1024 * 1024){
				alert('æ–‡ä»¶è¿‡å¤§ï¼æœ€å¤§æ”¯æŒ 5 MB');
				return;
			}

			// ä¸Šä¼ æ–‡ä»¶
			var formData = new FormData();
			formData.append('file', file);

			$.ajax({
				type: "POST",
				url: "/admin/uploadImage",
				data: formData,
				processData: false,
				contentType: false,
				dataType: "json",
				success: function(result){
					if(result.success){
						// æ’å…¥ Markdown å›¾ç‰‡è¯­æ³•åˆ°ç¼–è¾‘å™¨
						var imageMarkdown = '![' + file.name + '](' + result.url + ')';
						mdEditor.insertValue(imageMarkdown);
						alert('å›¾ç‰‡å·²æ’å…¥ç¼–è¾‘å™¨');
					} else {
						alert('ä¸Šä¼ å¤±è´¥ï¼š' + result.error);
					}
				},
				error: function(xhr, status, error){
					alert('ä¸Šä¼ å¤±è´¥ï¼š' + error);
				}
			});
		};
		input.click();
	}
</script>

</body>
</html>
